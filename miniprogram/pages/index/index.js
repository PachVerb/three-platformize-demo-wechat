"use strict";var e=require("../../chunks/three-platformize.js"),t=require("../../chunks/screenshot.js");class r extends e.Loader{constructor(e){super(e)}load(t,r,a,n){const o=this,s=new e.FileLoader(o.manager);s.setPath(o.path),s.setResponseType("arraybuffer"),s.setRequestHeader(o.requestHeader),s.setWithCredentials(o.withCredentials),s.load(t,(function(e){try{r(o.parse(e))}catch(e){n?n(e):console.error(e),o.manager.itemError(t)}}),a,n)}parse(r){function a(e,t){const r=e.length,a=new Float32Array(r+t.length);return a.set(e),a.set(t,r),a}var n=e.LoaderUtils.decodeText(new Uint8Array(r,0,250)).split("\n");return-1!==n[0].indexOf("xml")?function(r){function n(e){var t,r,a,n,o,s,i="undefined"!=typeof Uint8Array?Uint8Array:Array,l=[],d=[],c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",u=c.length;for(t=0;t<u;t++)l[t]=c[t];for(t=0;t<u;++t)d[c.charCodeAt(t)]=t;if(d["-".charCodeAt(0)]=62,d["_".charCodeAt(0)]=63,(u=e.length)%4>0)throw new Error("Invalid string. Length must be a multiple of 4");s=new i(3*u/4-(o="="===e[u-2]?2:"="===e[u-1]?1:0)),a=o>0?u-4:u;var h=0;for(t=0,r=0;t<a;t+=4,r+=3)n=d[e.charCodeAt(t)]<<18|d[e.charCodeAt(t+1)]<<12|d[e.charCodeAt(t+2)]<<6|d[e.charCodeAt(t+3)],s[h++]=(16711680&n)>>16,s[h++]=(65280&n)>>8,s[h++]=255&n;return 2===o?(n=d[e.charCodeAt(t)]<<2|d[e.charCodeAt(t+1)]>>4,s[h++]=255&n):1===o&&(n=d[e.charCodeAt(t)]<<10|d[e.charCodeAt(t+1)]<<4|d[e.charCodeAt(t+2)]>>2,s[h++]=n>>8&255,s[h++]=255&n),s}function o(e,r){var o,s,l,d,c=0;if("UInt64"===i.attributes.header_type?c=8:"UInt32"===i.attributes.header_type&&(c=4),"binary"===e.attributes.format&&r){var u,h,p,f,w,A;if("Float32"===e.attributes.type)var m=new Float32Array;else"Int64"===e.attributes.type&&(m=new Int32Array);h=(u=n(e["#text"]))[0];for(var g=1;g<c-1;g++)h|=u[g]<<g*c;for(f=(h+3)*c,A=f+=f%3>0?3-f%3:0,(w=[]).push(A),p=3*c,g=0;g<h;g++){for(var v=u[g*c+p],y=1;y<c-1;y++)v|=u[g*c+p+y]<<8*y;A+=v,w.push(A)}for(g=0;g<w.length-1;g++)L=t.unzlibSync(u.slice(w[g],w[g+1])).buffer,"Float32"===e.attributes.type?m=a(m,L=new Float32Array(L)):"Int64"===e.attributes.type&&(s=L=new Int32Array(L),l=void 0,d=void 0,l=(o=m).length,(d=new Int32Array(l+s.length)).set(o),d.set(s,l),m=d);delete e["#text"],"Int64"===e.attributes.type&&"binary"===e.attributes.format&&(m=m.filter((function(e,t){if(t%2!=1)return!0})))}else{if("binary"!==e.attributes.format||r)if(e["#text"])var L=e["#text"].split(/\s+/).filter((function(e){if(""!==e)return e}));else L=new Int32Array(0).buffer;else L=(L=n(e["#text"])).slice(c).buffer;delete e["#text"],"Float32"===e.attributes.type?m=new Float32Array(L):"Int32"===e.attributes.type?m=new Int32Array(L):"Int64"===e.attributes.type&&(m=new Int32Array(L),"binary"===e.attributes.format&&(m=m.filter((function(e,t){if(t%2!=1)return!0}))))}return m}var s=null;if(e.$window.DOMParser)try{s=(new e.$DOMParser).parseFromString(r,"text/xml")}catch(e){s=null}else{if(!e.$window.ActiveXObject)throw new Error("Cannot parse xml string!");try{if((s=new ActiveXObject("Microsoft.XMLDOM")).async=!1,!s.loadXML())throw new Error(s.parseError.reason+s.parseError.srcText)}catch(e){s=null}}var i=function e(t){var r={};if(1===t.nodeType){if(t.attributes&&t.attributes.length>0){r.attributes={};for(var a=0;a<t.attributes.length;a++){var n=t.attributes.item(a);r.attributes[n.nodeName]=n.nodeValue.trim()}}}else 3===t.nodeType&&(r=t.nodeValue.trim());if(t.hasChildNodes())for(var o=0;o<t.childNodes.length;o++){var s=t.childNodes.item(o),i=s.nodeName;if(void 0===r[i])""!==(d=e(s))&&(r[i]=d);else{if(void 0===r[i].push){var l=r[i];r[i]=[l]}var d;""!==(d=e(s))&&r[i].push(d)}}return r}(s.documentElement),l=[],d=[],c=[];if(i.PolyData){for(var u=i.PolyData.Piece,h=i.attributes.hasOwnProperty("compressor"),p=["PointData","Points","Strips","Polys"],f=0,w=p.length;f<w;){var A=u[p[f]];if(A&&A.DataArray){if("[object Array]"===Object.prototype.toString.call(A.DataArray))var m=A.DataArray;else m=[A.DataArray];for(var g=0,v=m.length;g<v;)"#text"in m[g]&&m[g]["#text"].length>0&&(m[g].text=o(m[g],h)),g++;switch(p[f]){case"PointData":var y=parseInt(u.attributes.NumberOfPoints),L=A.attributes.Normals;if(y>0)for(var x=0,b=m.length;x<b;x++)if(L===m[x].attributes.Name){var D=m[x].attributes.NumberOfComponents;(d=new Float32Array(y*D)).set(m[x].text,0)}break;case"Points":(y=parseInt(u.attributes.NumberOfPoints))>0&&(D=A.DataArray.attributes.NumberOfComponents,(l=new Float32Array(y*D)).set(A.DataArray.text,0));break;case"Strips":var T=parseInt(u.attributes.NumberOfStrips);if(T>0){var I=new Int32Array(A.DataArray[0].text.length),C=new Int32Array(A.DataArray[1].text.length);I.set(A.DataArray[0].text,0),C.set(A.DataArray[1].text,0);var P=T+I.length;c=new Uint32Array(3*P-9*T);var F=0;for(x=0,b=T;x<b;x++){for(var O=[],S=0,M=C[x],E=0;S<M-E;S++)O.push(I[S]),x>0&&(E=C[x-1]);var R=0;for(M=C[x],E=0;R<M-E-2;R++)R%2?(c[F++]=O[R],c[F++]=O[R+2],c[F++]=O[R+1]):(c[F++]=O[R],c[F++]=O[R+1],c[F++]=O[R+2]),x>0&&(E=C[x-1])}}break;case"Polys":var B=parseInt(u.attributes.NumberOfPolys);if(B>0){I=new Int32Array(A.DataArray[0].text.length),C=new Int32Array(A.DataArray[1].text.length),I.set(A.DataArray[0].text,0),C.set(A.DataArray[1].text,0),P=B+I.length,c=new Uint32Array(3*P-9*B),F=0;var N=0;for(x=0,b=B,E=0;x<b;){var G=[];for(S=0,M=C[x];S<M-E;)G.push(I[N++]),S++;for(R=1;R<M-E-1;)c[F++]=G[0],c[F++]=G[R],c[F++]=G[R+1],R++;E=C[++x-1]}}}}f++}var U=new e.BufferGeometry;return U.setIndex(new e.BufferAttribute(c,1)),U.setAttribute("position",new e.BufferAttribute(l,3)),d.length===l.length&&U.setAttribute("normal",new e.BufferAttribute(d,3)),U}throw new Error("Unsupported DATASET type")}(e.LoaderUtils.decodeText(r)):n[2].includes("ASCII")?function(t){var r,a=[],n=[],o=[],s=[],i=/^[^\d.\s-]+/,l=/(\-?\d+\.?[\d\-\+e]*)\s+(\-?\d+\.?[\d\-\+e]*)\s+(\-?\d+\.?[\d\-\+e]*)/g,d=/^(\d+)\s+([\s\d]*)/,c=/^POINTS /,u=/^POLYGONS /,h=/^TRIANGLE_STRIPS /,p=/^POINT_DATA[ ]+(\d+)/,f=/^CELL_DATA[ ]+(\d+)/,w=/^COLOR_SCALARS[ ]+(\w+)[ ]+3/,A=/^NORMALS[ ]+(\w+)[ ]+(\w+)/,m=!1,g=!1,v=!1,y=!1,L=!1,x=!1,b=!1,D=t.split("\n");for(var T in D){var I=D[T].trim();if(0===I.indexOf("DATASET")){var C=I.split(" ")[1];if("POLYDATA"!==C)throw new Error("Unsupported DATASET type: "+C)}else if(m)for(;null!==(r=l.exec(I))&&null===i.exec(I);){var P=parseFloat(r[1]),F=parseFloat(r[2]),O=parseFloat(r[3]);n.push(P,F,O)}else if(g){if(null!==(r=d.exec(I))){var S=parseInt(r[1]),M=r[2].split(/\s+/);if(S>=3)for(var E=parseInt(M[0]),R=1,B=0;B<S-2;++B)N=parseInt(M[R]),G=parseInt(M[R+1]),a.push(E,N,G),R++}}else if(v){if(null!==(r=d.exec(I))){var N,G;if(S=parseInt(r[1]),M=r[2].split(/\s+/),S>=3)for(B=0;B<S-2;B++)B%2==1?(E=parseInt(M[B]),N=parseInt(M[B+2]),G=parseInt(M[B+1]),a.push(E,N,G)):(E=parseInt(M[B]),N=parseInt(M[B+1]),G=parseInt(M[B+2]),a.push(E,N,G))}}else if(y||L)if(x)for(;null!==(r=l.exec(I))&&null===i.exec(I);){var U=parseFloat(r[1]),k=parseFloat(r[2]),V=parseFloat(r[3]);o.push(U,k,V)}else if(b)for(;null!==(r=l.exec(I))&&null===i.exec(I);){var X=parseFloat(r[1]),z=parseFloat(r[2]),H=parseFloat(r[3]);s.push(X,z,H)}null!==u.exec(I)?(g=!0,m=!1,v=!1):null!==c.exec(I)?(g=!1,m=!0,v=!1):null!==h.exec(I)?(g=!1,m=!1,v=!0):null!==p.exec(I)?(y=!0,m=!1,g=!1,v=!1):null!==f.exec(I)?(L=!0,m=!1,g=!1,v=!1):null!==w.exec(I)?(x=!0,b=!1,m=!1,g=!1,v=!1):null!==A.exec(I)&&(b=!0,x=!1,m=!1,g=!1,v=!1)}var W=new e.BufferGeometry;if(W.setIndex(a),W.setAttribute("position",new e.Float32BufferAttribute(n,3)),s.length===n.length&&W.setAttribute("normal",new e.Float32BufferAttribute(s,3)),o.length!==a.length)o.length===n.length&&W.setAttribute("color",new e.Float32BufferAttribute(o,3));else{var _=(W=W.toNonIndexed()).attributes.position.count/3;if(o.length===3*_){var j=[];for(T=0;T<_;T++)U=o[3*T+0],k=o[3*T+1],V=o[3*T+2],j.push(U,k,V),j.push(U,k,V),j.push(U,k,V);W.setAttribute("color",new e.Float32BufferAttribute(j,3))}}return W}(e.LoaderUtils.decodeText(r)):function(t){var r,a,n,o,s,i,l,d=new Uint8Array(t),c=new DataView(t),u=[],h=[],p=[],f=0;function w(e,t){for(var r=t,a=e[r],n=[];10!==a;)n.push(String.fromCharCode(a)),a=e[++r];return{start:t,end:r,next:r+1,parsedString:n.join("")}}for(;;){if(0===(l=(i=w(d,f)).parsedString).indexOf("DATASET")){var A=l.split(" ")[1];if("POLYDATA"!==A)throw new Error("Unsupported DATASET type: "+A)}else if(0===l.indexOf("POINTS")){for(r=4*(o=parseInt(l.split(" ")[1],10))*3,u=new Float32Array(3*o),a=i.next,n=0;n<o;n++)u[3*n]=c.getFloat32(a,!1),u[3*n+1]=c.getFloat32(a+4,!1),u[3*n+2]=c.getFloat32(a+8,!1),a+=12;i.next=i.next+r+1}else if(0===l.indexOf("TRIANGLE_STRIPS")){var m=parseInt(l.split(" ")[1],10);r=4*(x=parseInt(l.split(" ")[2],10)),p=new Uint32Array(3*x-9*m);var g=0;for(a=i.next,n=0;n<m;n++){var v=c.getInt32(a,!1),y=[];for(a+=4,s=0;s<v;s++)y.push(c.getInt32(a,!1)),a+=4;for(var L=0;L<v-2;L++)L%2?(p[g++]=y[L],p[g++]=y[L+2],p[g++]=y[L+1]):(p[g++]=y[L],p[g++]=y[L+1],p[g++]=y[L+2])}i.next=i.next+r+1}else if(0===l.indexOf("POLYGONS")){var x;for(m=parseInt(l.split(" ")[1],10),r=4*(x=parseInt(l.split(" ")[2],10)),p=new Uint32Array(3*x-9*m),g=0,a=i.next,n=0;n<m;n++){for(v=c.getInt32(a,!1),y=[],a+=4,s=0;s<v;s++)y.push(c.getInt32(a,!1)),a+=4;for(L=1;L<v-1;L++)p[g++]=y[0],p[g++]=y[L],p[g++]=y[L+1]}i.next=i.next+r+1}else if(0===l.indexOf("POINT_DATA")){for(o=parseInt(l.split(" ")[1],10),i=w(d,i.next),r=4*o*3,h=new Float32Array(3*o),a=i.next,n=0;n<o;n++)h[3*n]=c.getFloat32(a,!1),h[3*n+1]=c.getFloat32(a+4,!1),h[3*n+2]=c.getFloat32(a+8,!1),a+=12;i.next=i.next+r}if((f=i.next)>=d.byteLength)break}var b=new e.BufferGeometry;return b.setIndex(new e.BufferAttribute(p,1)),b.setAttribute("position",new e.BufferAttribute(u,3)),h.length===u.length&&b.setAttribute("normal",new e.BufferAttribute(h,3)),b}(r)}}class a extends t.Demo{async init(){const a=new e.MeshLambertMaterial({color:1193046,side:e.DoubleSide}),n=new r,o=await n.loadAsync(t.baseUrl+"models/vtk/bunny.vtk");o.center(),o.computeVertexNormals();const s=new e.Mesh(o,a);console.log(o),this.add(new e.DirectionalLight(16777215,1)),this.add(new e.AmbientLight(16777215,1)),this.add(s),this.deps.camera.position.z=.5,this.deps.scene.position.z=0,this.addControl()}update(){!function(e){let t,r=e[0],a=1;for(;a<e.length;){const n=e[a],o=e[a+1];if(a+=2,("optionalAccess"===n||"optionalCall"===n)&&null==r)return;"access"===n||"optionalAccess"===n?(t=r,r=o(r)):"call"!==n&&"optionalCall"!==n||(r=o(((...e)=>r.call(t,...e))),t=void 0)}}([this,"access",e=>e.orbitControl,"optionalAccess",e=>e.update,"call",e=>e()])}dispose(){this.reset()}}function n(e){let t,r=e[0],a=1;for(;a<e.length;){const n=e[a],o=e[a+1];if(a+=2,("optionalAccess"===n||"optionalCall"===n)&&null==r)return;"access"===n||"optionalAccess"===n?(t=r,r=o(r)):"call"!==n&&"optionalCall"!==n||(r=o(((...e)=>r.call(t,...e))),t=void 0)}return r}console.log("THREE Version",e.REVISION);const o={MemoryTest:t.DemoMemoryTest,VTKLoader:a,MeshOpt:t.DemoMeshOpt,TGALoader:t.DemoTGALoader,PDBLoader:t.DemoPDBLoader,STLLoader:t.DemoSTLLoader,TTFLoader:t.DemoTTFLoader,BVHLoader:t.DemoBVHLoader,FBXLoader:t.DemoFBXLoader,LWOLoader:t.DemoLWOLoader,MTLLoader:t.DemoMTLLoader,EXRLoader:t.DemoEXRLoader,OBJLoader:t.DemoOBJLoader,SVGLoader:t.DemoSVGLoader,RGBELoader:t.DemoRGBELoader,GLTFLoader:t.DemoGLTFLoader,ColladaLoader:t.DemoColladaLoader,MeshQuantization:t.DemoMeshQuantization,ThreeSpritePlayer:t.DemoThreeSpritePlayer,HDRPrefilterTexture:t.DemoHDRPrefilterTexture,DeviceOrientationControls:t.DemoDeviceOrientationControls},s=e=>new Promise((t=>wx.createSelectorQuery().select(e).fields({node:!0,size:!0}).exec(t)));Page({disposing:!1,switchingItem:!1,deps:{},currDemo:null,platform:null,helperCanvas:null,data:{showMenu:!0,showCanvas:!1,currItem:-1,menuList:["GLTFLoader","ThreeSpritePlayer","DeviceOrientationControls","RGBELoader","SVGLoader","OBJLoader","MeshOpt","EXRLoader","HDRPrefilterTexture","MTLLoader","LWOLoader","FBXLoader","BVHLoader","ColladaLoader","MeshQuantization","TTFLoader","STLLoader","PDBLoader","TGALoader","VTKLoader","MemoryTest"]},onReady(){this.onCanvasReady()},onCanvasReady(){console.log("onCanvasReady"),Promise.all([s("#gl"),s("#canvas")]).then((([e,t])=>{this.initCanvas(e[0].node,t[0].node)}))},initCanvas(r,a){const o=new t.WechatPlatform(r);this.platform=o,o.enableDeviceOrientation("game"),e.PLATFORM.set(o),console.log(e.$window.innerWidth,e.$window.innerHeight),console.log(r.width,r.height);const s=new e.WebGL1Renderer({canvas:r,antialias:!0,alpha:!1}),i=new e.PerspectiveCamera(75,r.width/r.height,.1,1e3),l=new e.Scene,d=new e.Clock,c=new t.GLTFLoader,u=new e.TextureLoader;this.deps={renderer:s,camera:i,scene:l,clock:d,gltfLoader:c,textureLoader:u},this.helperCanvas=a,l.position.z=-3,l.background=new e.Color(16777215),s.outputEncoding=e.sRGBEncoding,s.setPixelRatio(2),s.setSize(r.width,r.height);const h=()=>{this.disposing||(e.$requestAnimationFrame(h),n([this.currDemo,"optionalAccess",e=>e.update,"call",e=>e()]),s.render(l,i))};h(),console.log("canvas inited")},onMenuClick(){const e=!this.data.showMenu;e?this.setData({showMenu:e,showCanvas:!1}):(this.setData({showMenu:e}),setTimeout((()=>{this.setData({showCanvas:!0})}),330))},async onMenuItemClick(e){const{i:t,item:r}=e.currentTarget.dataset;if(wx.showLoading({mask:!1,title:"加载中"}),this.switchingItem||!o[r])return;n([this.currDemo,"optionalAccess",e=>e.dispose,"call",e=>e()]),this.switchingItem=!0,this.currDemo=null;const a=new o[r](this.deps);await a.init(),this.currDemo=a,this.setData({currItem:t}),this.onMenuClick(),this.switchingItem=!1,wx.hideLoading()},onTX(e){this.platform.dispatchTouchEvent(e)},screenshot(){const{renderer:r,scene:a,camera:n}=this.deps,[o,s,i]=t.screenshot(r,a,n,e.WebGLRenderTarget),l=this.helperCanvas.getContext("2d"),d=this.helperCanvas.createImageData(o,s,i);this.helperCanvas.height=d.height,this.helperCanvas.width=d.width,l.putImageData(d,0,0);const c=l.getImageData(0,0,s,i).data.some((e=>0!==e));console.log("hasPixel",c),wx.canvasToTempFilePath({canvas:this.helperCanvas,success(e){wx.previewImage({urls:[e.tempFilePath]})}})},async screenrecord(){console.log("screenrecord clicked");const e=this.deps.renderer.domElement,t=wx.createMediaRecorder(e,{fps:20,videoBitsPerSecond:600,duration:5});await new Promise((e=>{t.on("start",e),t.start()})),console.log("start");let r=100;for(;r--;)await new Promise((e=>t.requestFrame(e))),await new Promise((e=>setTimeout(e,50))),console.log(r);const{tempFilePath:a}=await new Promise((e=>{t.on("stop",e),t.stop()}));console.log(a),t.destroy(),wx.previewMedia({sources:[{url:a,type:"video"}]})},onUnload(){this.disposing=!0,n([this.currDemo,"optionalAccess",e=>e.dispose,"call",e=>e()]),e.PLATFORM.dispose()},onShareAppMessage(){}});
