"use strict";var e=require("../../chunks/three-platformize.js"),o=require("../../chunks/screenshot.js");function a(e){let o,a=e[0],t=1;for(;t<e.length;){const s=e[t],r=e[t+1];if(t+=2,("optionalAccess"===s||"optionalCall"===s)&&null==a)return;"access"===s||"optionalAccess"===s?(o=a,a=r(a)):"call"!==s&&"optionalCall"!==s||(a=r(((...e)=>a.call(o,...e))),o=void 0)}return a}console.log("THREE Version",e.REVISION);const t={MemoryTest:o.DemoMemoryTest,MeshOpt:o.DemoMeshOpt,TGALoader:o.DemoTGALoader,PDBLoader:o.DemoPDBLoader,STLLoader:o.DemoSTLLoader,TTFLoader:o.DemoTTFLoader,BVHLoader:o.DemoBVHLoader,FBXLoader:o.DemoFBXLoader,LWOLoader:o.DemoLWOLoader,MTLLoader:o.DemoMTLLoader,EXRLoader:o.DemoEXRLoader,OBJLoader:o.DemoOBJLoader,SVGLoader:o.DemoSVGLoader,RGBELoader:o.DemoRGBELoader,GLTFLoader:o.DemoGLTFLoader,ColladaLoader:o.DemoColladaLoader,MeshQuantization:o.DemoMeshQuantization,ThreeSpritePlayer:o.DemoThreeSpritePlayer,HDRPrefilterTexture:o.DemoHDRPrefilterTexture,DeviceOrientationControls:o.DemoDeviceOrientationControls},s=e=>new Promise((o=>wx.createSelectorQuery().select(e).fields({node:!0,size:!0}).exec(o)));Page({disposing:!1,switchingItem:!1,deps:{},currDemo:null,platform:null,helperCanvas:null,data:{showMenu:!0,showCanvas:!1,currItem:-1,menuList:["GLTFLoader","ThreeSpritePlayer","DeviceOrientationControls","RGBELoader","SVGLoader","OBJLoader","MeshOpt","EXRLoader","HDRPrefilterTexture","MTLLoader","LWOLoader","FBXLoader","BVHLoader","ColladaLoader","MeshQuantization","TTFLoader","STLLoader","PDBLoader","TGALoader","MemoryTest"]},onReady(){this.onCanvasReady()},onCanvasReady(){console.log("onCanvasReady"),Promise.all([s("#gl"),s("#canvas")]).then((([e,o])=>{this.initCanvas(e[0].node,o[0].node)}))},initCanvas(t,s){const r=new o.WechatPlatform(t);this.platform=r,r.enableDeviceOrientation("game"),e.PLATFORM.set(r),console.log(e.$window.innerWidth,e.$window.innerHeight),console.log(t.width,t.height);const n=new e.WebGL1Renderer({canvas:t,antialias:!0,alpha:!0}),i=new e.PerspectiveCamera(75,t.width/t.height,.1,1e3),d=new e.Scene,l=new e.Clock,h=new o.GLTFLoader,c=new e.TextureLoader;this.deps={renderer:n,camera:i,scene:d,clock:l,gltfLoader:h,textureLoader:c},this.helperCanvas=s,d.position.z=-3,n.outputEncoding=e.sRGBEncoding,n.setSize(t.width,t.height),n.setPixelRatio(e.$window.devicePixelRatio);const L=()=>{this.disposing||(e.$requestAnimationFrame(L),a([this.currDemo,"optionalAccess",e=>e.update,"call",e=>e()]),n.render(d,i))};L(),console.log("canvas inited")},onMenuClick(){const e=!this.data.showMenu;e?this.setData({showMenu:e,showCanvas:!1}):(this.setData({showMenu:e}),setTimeout((()=>{this.setData({showCanvas:!0})}),330))},async onMenuItemClick(e){const{i:o,item:s}=e.currentTarget.dataset;if(wx.showLoading({mask:!1,title:"加载中"}),this.switchingItem||!t[s])return;a([this.currDemo,"optionalAccess",e=>e.dispose,"call",e=>e()]),this.switchingItem=!0,this.currDemo=null;const r=new t[s](this.deps);await r.init(),this.currDemo=r,this.setData({currItem:o}),this.onMenuClick(),this.switchingItem=!1,wx.hideLoading()},onTX(e){this.platform.dispatchTouchEvent(e),this.platform.dispatchTouchEvent(e)},screenshot(){const{renderer:a,scene:t,camera:s}=this.deps,[r,n,i]=o.screenshot(a,t,s,e.WebGLRenderTarget),d=this.helperCanvas.getContext("2d"),l=this.helperCanvas.createImageData(r,n,i);this.helperCanvas.height=l.height,this.helperCanvas.width=l.width,d.putImageData(l,0,0);const h=d.getImageData(0,0,n,i).data.some((e=>0!==e));console.log("hasPixel",h),wx.canvasToTempFilePath({canvas:this.helperCanvas,success(e){wx.previewImage({urls:[e.tempFilePath]})}})},onUnload(){this.disposing=!0,a([this.currDemo,"optionalAccess",e=>e.dispose,"call",e=>e()]),e.PLATFORM.dispose()}});
